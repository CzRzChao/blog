---
title: lnmp安装手册
date: 2017-11-14 16:48:30
categories: 
- lnmp
tags: 
- php
- linux
- mysql
- nginx
---

本文主要是通过针对lnmp的环境搭建做一个系统性的总结，方便用时查找。

# 概述
最流行的web研发生态当属Linux+Nginx+Mysql+PHP了，此四者均开源免费，且社区活跃，是web开发的利器。俗话说，工欲善其事，必先利其器。lnmp架构是业务的基础，虽然在企业中环境都由运维部门接管，业务RD不需要为此操心，但业务运行在什么样的环境下，会遇到什么样的问题，作为业务RD却又不得不去弄清楚他们之间的关系。  

此文主要以实际着手搭建一套lnmp环境为主线，介绍其中涉及到的技术点。包括php配置、php-fpm配置、nginx配置、mysql配置。以及这他们之间的关系。

***

# 准备工作
## 源码下载
1. Linux: 本文是基于CentOS6.5
2. Nginx: 1.13.4，下载地址：[http://nginx.org/download/nginx-1.13.4.tar.gz](http://nginx.org/download/nginx-1.13.4.tar.gz)
3. Mysql: 5.6.37，下载地址：[https://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-5.6.37.tar.gz](https://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-5.6.37.tar.gz)
4. PHP: 5.5.38，下载地址：[http://cn2.php.net/distributions/php-5.5.38.tar.gz](http://cn2.php.net/distributions/php-5.5.38.tar.gz)

在/usr/local目录下创建我们的LNMP安装目录，我们这里定义为lnmp  

```shell
mkdir -p /usr/local/lnmp/src
wget -P /usr/local/lnmp/src http://nginx.org/download/nginx-1.13.4.tar.gz
wget -P /usr/local/lnmp/src https://github.com/mysql/mysql-server/archive/mysql-5.6.37.tar.gz
wget -P /usr/local/lnmp/src http://cn2.php.net/distributions/php-5.5.38.tar.gz
```

为了方便知道我们安装的软件版本，故目录命名均采用软件名-三位版本号的形式：  

```shell
mkdir /usr/local/lnmp/php-5.5.38
mkdir /usr/local/lnmp/mysql-5.6.37
mkdir /usr/local/lnmp/nginx-1.10.3
```

## 工具准备

本问所有的安装都是根据源码进行编译安装，需要使用到的工具有:  

### cmake
cmake是一款开源跨平台的编译工具，其包含编译构建、测试打包等一体的工具包。mysql5.5以上的版本都要通过cmake进行编译安装。

* 官网: [https://cmake.org/](https://cmake.org/)
* 下载地址: [https://cmake.org/files/v3.9/cmake-3.9.1.tar.gz](https://cmake.org/files/v3.9/cmake-3.9.1.tar.gz)
* github: [https://github.com/Kitware/CMake/archive/v3.9.1.tar.gz](https://github.com/Kitware/CMake/archive/v3.9.1.tar.gz)

### GCC(version >= 4.2.1)
作为RD应该都或多或少的了解过GCC（the GNU Compiler Collection），即GNU编译套件集合，是由 GNU 开发的编程语言编译器。它是以GPL许可证所发行的自由软件。其包括C、C++、Objective-C、Fortran、Java、Ada和Go语言的前端，也包括了这些语言的库（如libstdc++、libgcj等等）。这里给出官网地址: [http://gcc.gnu.org/](http://gcc.gnu.org/)

### make(version >= 3.75)
又叫GNU Make，此软件是GNU系列的编译软件。在linux下编译软件几乎是必不可少的。

* 官网: [http://www.gnu.org/software/make/](http://www.gnu.org/software/make/)
* 使用手册: [http://www.gnu.org/software/make/manual/make.html](http://www.gnu.org/software/make/manual/make.html)

> mysql源码编译安装依赖 [https://dev.mysql.com/doc/refman/5.6/en/source-installation.html](https://dev.mysql.com/doc/refman/5.6/en/source-installation.html)

***
# Nginx安装
## 编译安装

```shell
#解压源码文件
cd /usr/local/lnmp/src
tar -zxf nginx-1.13.4.tar.gz
cd nginx-1.13.4
​
#执行configure，指定安装目录为 /usr/local/lnmp/nginx-1.13.4
./configure --prefix=/usr/local/lnmp/nginx-1.13.4
make && make install
​
#进入nginx安装目录，检测是否安装成功
cd /usr/local/lnmp/nginx-1.13.4
​
#执行下列命令，若出现错误，跟进错误进行修正
nginx -t 
```

## 软件配置
本文只介绍最简单的基本配置，主要是为了让环境能够正常跑起来

### nginx.conf

```shell
#user  nobody;
worker_processes  1;
​
pid logs/nginx.pid;
​
events {
    worker_connections  1024;
}
​
http {
    include       mime.types;
    default_type  application/octet-stream;
    #日志格式
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
​
    sendfile        on;
    keepalive_timeout  65;
​
    #gzip  on;
    include vhost/*.conf;
}
```

### vhost
一套lnmp环境下可能运行不止一个服务，一次我们在nginx的conf目录下创建vhost目录，用于存放虚拟主机。

```shell
server {
    listen       8000;
    server_name  localhost;
    access_log  logs/host.access.log  main;
​
    location / {
        root   /data0/www/htdocs/lnmp.com;
        index  index.php;
    }
​
    #error_page  404              /404.html;
​
    # redirect server error pages to the static page /50x.html
    error_page   500 502 503 504  /50x.html;
​
    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    location ~ \.php$ {
        root           /data0/www/htdocs/lnmp.com;
        fastcgi_pass   127.0.0.1:9000;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        include        fastcgi_params;
    }
}
```

## 测试
检测安装是否成功，进入 `/usr/local/lnmp/nginx-1.13.4/sbin`目录，执行`./nginx -t`命令，若输出如下信息，则表示安装成功。

```shell
nginx: the configuration file /usr/local/lnmp/nginx-1.13.4/conf/nginx.conf syntax is ok nginx: configuration file /usr/local/lnmp/nginx-1.13.4/conf/nginx.conf test is successful
```

## 使用
nginx安装完成后，目录如下：

```shell
.
├── client_body_temp
├── conf //此目录为存放配置文件目录
│   └── vhost
├── fastcgi_temp
├── html //存放网站代码的目录，一般情况下，我们会有自己的网站目录，这里可以存放一些统一的4xx、5xx页面。
# ├── logs //默认存放nginx运行日志的地方
├── proxy_temp
├── sbin //此目录是存放执行命令的目录
├── scgi_temp
└── uwsgi_temp
```

### sbin
这里我们先说sbin目录，其中只有一个文件nginx可执行文件，此文件用于管理nginx的启动、停止、重启。

nginx命令支持以下参数：

* -v ：显示版本号并退出
* -V：显示版本号，同时显示编译时选项并退出
* -t：测试配置文件，并退出
* -T：测试配置文件，并将其输出，然后退出
* -s signal：发送信号给nginx master，用于平滑停止，退出，平滑重启，重启。signal包括（stop\|quit\|reload\|reopen）
* -c：指定nginx的配置文件，默认为conf/nginx.conf
* -g：设置配置文件之外的全局指令，用的比较少

#### nginx启动
使用默认的配置文件：

```shell
/usr/local/lnmp/nginx-1.13.4/sbin/nginx 
```

使用指定的配置文件：

```shell
/usr/local/lnmp/nginx-1.13.4/sbin/nginx -c /path/yourConfigFile
```

#### nginx停止

```shell
/usr/local/lnmp/nginx-1.13.4/sbin/nginx -s stop
```
对于nginx停止还可以使用kill命令

```shell
kill -QUIT 主进程pid 或 kill -QUIT `cat /path/pid` # 从容关闭
kill -TERM 主进程pid 或 kill -TERM `cat /path/pid` # 快速关闭
kill -INT 主进程pid 或 kill -INT `cat /path/pid`   # 快速关闭
pKill -9 主进程pid 或 pkill -9 `cat /path/pid`     # 强制关闭
```

#### nginx重启

```shell
/usr/local/lnmp/nginx-1.13.4/sbin/nginx -s reload
```
同理，重启也能使用kill命令

```shell
kill -USR2 `cat /path/pid`
# 如本文中的示例:
kill -USR2 `cat /usr/local/lnmp/nginx-1.13.4/logs/nginx.pid`
```

### conf
nginx配置文件主要为nginx.conf，这里我们就来详细解读下其中的相关配置指令及含义。  
nginx的强大都是靠配置文件来实现，nginx就是一个二进制文件，nginx读入一个配置文件nginx.conf(nginx.conf可能include包含若干子配置文件)来实现各种各样的功能。我们分段来介绍nginx.conf文件。

#### 全局配置

```shell
worker_processes  1;
#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
pid        logs/nginx.pid; 
events {
    worker_connections  1024;
}
```
这些是配置文件开始的默认行。通常的环境下，你不需要修改这些选项。这一部分有几个方面需要我们注意：

* 所有以#号开的行是注释，nginx不会解析。默认的配置文件有许多说明解释的注释块
* 指令是以一个变量名开头(例如，worker_processes或pid),然后包含一个参数(例如，1或 logs/nginx.pid)或者多个参数(例如，"logs/error.log notice")
* 所有指令以分号结尾
* 某些指令，像上面的events可以包含多个子指令作为参数。这些子指令以花括号包围。
* 虽然nginx不解析空白符(例如tab，空格，和换行符)，但是良好的缩进能提高你维护长期运行配置文件的效率。良好的缩进使配置文件读起来更流畅，能让你很容易明白配置的策略，即使几个月前。

#### http段
官方定义如下：

```shell
Syntax: http { ... }
Default:    —
Context:    main
```
示例如下： 

```shell
http {
    include       mime.types;
    default_type  application/octet-stream;
​
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
​
    #access_log  logs/access.log  main;
​
    sendfile        on;
    #tcp_nopush     on;
​
    #keepalive_timeout  0;
    keepalive_timeout  65;
​
    #gzip可以参考官方文档：http://nginx.org/en/docs/http/ngx_http_gzip_module.html
    gzip  on;
    gzip_min_length 1000;
    gzip_proxied    expired no-cache no-store private auth;
    gzip_types      text/plain application/xml;
    gzip_comp_level 1;
    include vhost/*.conf;
}
```
> 参考官方文档：[http://nginx.org/en/docs/http/ngx_http_log_module.html#access_log](http://nginx.org/en/docs/http/ngx_http_log_module.html#access_log)

"http { }"块的开头像配置文件的开头一样都是标准配置不需要修改。这里我们需要把注意力放在这些元素上:

 * 这部分内容的开始"include"语句包含/usr/local/lnmp/nginx-1.13.4/conf/mime.types文件到nginx.conf文件include语句所在位置。include对ningx.conf文件的可读性和组织性很有用。
 * 不能过多使用include，如果太多递归地include文件会产生混乱，所以需要合理有限制地使用include来保证配置文件的清晰和可管理。
 * 你可以去掉log_format指令前的注释并修改这几行设置的变量为你想记录的信息。
 * gzip指令告诉nginx使用gzip压缩的方式来降低带宽使用和加快传输速度。如果想使用gzip压缩，需要添加如下配置到配置文件的gzip位置。
 * include vhost/*.conf;表示包含的虚拟主机配置，这将在下一段讲解。

#### server段

虚拟主机配置指令块为server，其包含与http指令块中，为了方面我们配置，我们将其独立出来，通过include指令将其包含进入http指令块中去。

```shell
Syntax: server { ... }
Default:    —
Context:    http
```
示例如下：

```shell
server {
    listen       9091;
    server_name  localhost;
​
    #charset koi8-r;
​
    access_log  logs/host.access.log  main;
​
    location / {
      root   /data0/www/htdocs/lnmp.com;
      index  index.php;
    }
​
    #error_page  404              /404.html;
​
    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
​
    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}
​
    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    location ~ \.php$ {
      root           /data0/www/htdocs/lnmp.com;
      fastcgi_pass   127.0.0.1:9000;
      fastcgi_index  index.php;
      fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
      include        fastcgi_params;
    }
​
    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}
```

未完待续。。。
